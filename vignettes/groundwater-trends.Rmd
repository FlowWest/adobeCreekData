---
title: "Groundwater Trends"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Groundwater Trends}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  echo = FALSE,
  warning = FALSE, 
  message = FALSE
)
```

```{r setup}
library(adobeCreekData)
library(tidyverse)
library(leaflet)
library(lubridate)
library(gridExtra)
```


## Introduction 

In this article I explore groundwater elevation trends, we are interested in exploring 
elevation differences by water year. We will focus only on wells that have had recent
measurements. Ultimately we would like to develop confidence intervals for elevation change
based on the characteristics of a water year. 


## Groundwater Well Selection 

We will focus on wells where a groundwater elevation was reported for 2018. This
results in 23 candiate wells for analysis. This number will be smaller as we seek 
to make comparison across years.

```{r}
stations_with_recent_data <- groundwater_stations %>% 
  filter(year(end_date) >= 2018) 

elevation_data <- groundwater_levels %>% 
  filter(site_code %in% stations_with_recent_data$site_code) %>% 
  select(site_code, date = measurement_date, wse)


groundwater_stations %>% 
  filter(year(end_date) >= 2018) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers() 
```

## Elevation Change

Here I look at the change of elevation in one year. Here are the assumptions and requirements for
this analysis:

1. site code must have recent data to at least 2018
2. only subsequent years of data will be taken into account 
3. when attaching water year types to the fall difference we will always use the 
water year for September. For example even though the difference is from November 1980
to November 1981, the water year associated with this difference will be 1980.

**How the difference is calcualted**

The difference is calculated by subtracting the "start year" (smaller of the years) 
from the "end year". This means that a positive value indicates elevation increase
and a negative value indicates elevation decrease. When looking at the plot, a point
on 1980 shows the difference between 1979 and 1980. Lastly this subtraction is done 
on each well, so when looking the plot a single point shows the difference between 
two years at an individual site code. We can see the spread of the difference values
for a given year by focusing on one year on the x-axis and observing the range 
of values on the y-axis.

```{r}
wy_types <- 
  waterYearType::water_year_indices %>% 
  filter(location == "Sacramento Valley") %>% select(year = WY, type = Yr_type)

one_year_differences <- purrr::map_df(1948:2018, function(y) {
  # get the start and end years for the calcuation
  year1 <- y - 1
  year2 <- y
  
  # filter the data to just these two years
  d <- elevation_data %>% 
    filter(month(date) %in% 8:11, year(date) %in% c(year1, year2)) 
  
  # if there is no data for these two years do not do anything else
  if (nrow(d) == 0) return(NULL)
  d2 <- d %>% 
    mutate(year = ifelse(year(date) == year1, "start_year", "end_year")) %>% 
    select(-date) %>% 
    group_by_at(vars(-wse)) %>%  # group by everything other than the value column. 
    mutate(row_id=1:n()) %>% 
    ungroup() %>% 
    spread(year, wse) 
  
  if (!("end_year" %in% colnames(d2))) return(NULL)
  if (!("start_year" %in% colnames(d2))) return(NULL)
  
  d2 %>% 
    mutate(difference = end_year - start_year) %>% 
    filter(!is.na(difference)) %>% 
    mutate(end_year = year2, 
           start_year = year1)
}) %>% 
  left_join(wy_types, by = c("end_year" = "year")) %>% 
  rename(end_year_type = type) %>% 
  left_join(wy_types, by = c("start_year" = "year")) %>% 
  rename(start_year_type = type) %>% 
  mutate(year_type_change = paste0(start_year_type, " to ", end_year_type)) %>% 
  filter(!is.na(end_year_type)) %>% 
  group_by(end_year_type) %>% 
  mutate(is_outlier = ifelse(difference %in% boxplot(difference, plot=FALSE)$out, TRUE, FALSE)) %>% 
  ungroup()
```

### Elevation Change Time Series By Water Year Type

Here I color code the points by the water year type of the end year. That
is, when looking at the year 1980 the value indicates the difference between wells
from 1979 to 1980 but the color shows the water year type for 1980. No obvious patterns
appear in the data. I instead switch to looking at the distribution of elvetaion changes 
for each of the water year types.

```{r}
one_year_differences %>% 
  ggplot(aes(end_year, difference, color=end_year_type)) + 
  geom_point(alpha=0.7) + 
  labs(title = "Water Year Type of End Year", color="", x = "", 
       y = "Elevation Change") + 
  scale_color_brewer(palette = "Spectral") + 
  theme(legend.position="bottom")
```

### Distribution of Elevation Changes

With the water years attached we can do some statistics using these as
categorical variables. We are mainly interested in significant differences in 
elevation change as a result of the water year types. In order to do so we need to 
have enough samples from the each of the water year types.

**Year Type Representation**

```{r}
one_year_differences %>% 
  group_by(end_year_type) %>% 
  summarise(
    total = n(), 
    `Percent of data (%)` = round(total/nrow(one_year_differences), 2) * 100
  ) %>% 
  rename(`Year Type` = end_year_type, 
         Total = total) %>% 
  knitr::kable()
```

Most of the data is from either a Wet or Dry year, but we do have enough samples each of
the other water years.

#### Significant Differences between year types

In this section I analyze the distribution of elevation change between the water year
types. In particular we are interested in answering the following questions: 

1. Is there a significant difference between dry years (dry, critical) and wet years
(Abobe Normal, Wet).
2. Does the water year type of the previous affect the elevation change? If so how much?
3. Given a water year type is there a range of expected elevation change we can anticipate?
4. For all of the above, if we can't answer then question now, what additional data would 
we need to do so?

Several assumptions must be met before we develop statistical test

#### Question 1: Significant Differences between Year Types

In this section I explore the differences between the elevation changes across the different
water year types. We want to be able to state whether the distributions shown in the boxplots
below are significantly different from one another. 

```{r}
one_year_differences %>% 
  ggplot(aes(end_year_type, difference, fill=end_year_type)) + 
  geom_boxplot() + 
  labs(x = "", y = "Elevation Change", 
       title = "Elevation Change Distribution by Water Year Types", 
       fill="") + 
  scale_fill_brewer(palette = "Spectral")  + 
  theme(legend.position="bottom") + 
  coord_flip()

one_year_differences %>%
  filter(!is_outlier) %>% 
  ggplot(aes(end_year_type, difference, fill=end_year_type)) + 
  geom_boxplot() + 
  labs(x = "", y = "Elevation Change", 
       title = "Elevation Change Distribution by Water Year Types (outliers removed)", 
       fill="") + 
  scale_fill_brewer(palette = "Spectral")  + 
  theme(legend.position="bottom") + 
  coord_flip()
```

The plan here is to use two sample test to check for significant differences. There are several
assumtpions that need to be satisfied in order for this analysis to be valid, we check these below.


**Assumption checks**

_Normality_

From the boxplot we can see that the elevation change across all of the water year
types are at least symmetrical. There might be some issues from the detected outliers.
I apply the **Shapiro** test to check for normality before and after removing outliers.

```{r}
shapiro_results <- one_year_differences %>% 
  group_by(end_year_type) %>% 
  summarise(
    shapiro_pvalue = shapiro.test(difference)$p.value, 
    total_in_sample = n()
  ) 

shapiro_no_outliers_results <- one_year_differences %>%
  filter(!is_outlier) %>% 
  group_by(end_year_type) %>% 
  summarise(
    shapiro_no_outliers_pvalue = shapiro.test(difference)$p.value, 
    total_in_sample = n()
  ) 

shapiro_results %>% 
  left_join(shapiro_no_outliers_results, by = c("end_year_type" = "end_year_type"), 
            suffix = c("", "_no_outliers")) %>% 
  gather(type, p_value, shapiro_pvalue, shapiro_no_outliers_pvalue) %>% 
  mutate(test_pass = p_value > .05, 
         total_outliers = total_in_sample - total_in_sample_no_outliers) %>% 
  select(
    `Water Year Type` = end_year_type, 
    `Total Sample` = total_in_sample, 
    `Total Outliers Detected` = total_outliers, 
    type, test_pass
  ) %>% 
  spread(type, test_pass) %>% 
  rename("Test on Full Sample" = shapiro_pvalue, 
         "Test with Removed Outliers" = shapiro_no_outliers_pvalue) %>% 
  knitr::kable()
# 
# one_year_differences %>% 
#   filter(!is_outlier) %>% 
#   ggplot(aes(difference, fill = end_year_type)) + geom_density() + 
#   scale_fill_brewer(palette = "Spectral")  + 
#   facet_grid(end_year_type ~ .) + 
#   theme(legend.position="bottom")  
```

From the above results we can see that none of the elevation change distrubtions (that include
the outliers) can be assumed to be normally distributed. When we remove the outliers, counted 
under the _Total Outliers Detected_ column, then most of the Water Year types can be considered
normally distribute, with the exception of the Above Normal elevation changes.

*Wet Year vs Dry Year*

```{r}
p1 <- one_year_differences %>%
  filter(end_year_type %in% c("Wet", "Dry"), !is_outlier) %>% 
  ggplot(aes(end_year_type, difference, fill = end_year_type)) + 
  geom_boxplot() + 
  coord_flip() + 
  scale_fill_manual(values = c("#fdae61", "#2b83ba")) + 
  labs(fill="Year Type", y = "", x = "")

p2 <- one_year_differences %>%
  filter(end_year_type %in% c("Wet", "Dry"), !is_outlier) %>% 
  ggplot(aes(difference, fill = end_year_type)) + geom_density(alpha=0.6) + 
    scale_fill_manual(values = c("#fdae61", "#2b83ba")) + 
  labs(fill="Year Type")

grid.arrange(p1, p2, nrow = 2)
```

```{r}
wet_vals <- one_year_differences %>% filter(!is_outlier, end_year_type == "Wet") %>%
  pull(difference)
dry_vals <- one_year_differences %>% filter(!is_outlier, end_year_type == "Dry") %>%
  pull(difference)

wet_vs_dry_t_test <- t.test(wet_vals, dry_vals)
```

*Wet Year vs Critical Year*

```{r}
p1 <- one_year_differences %>%
  filter(end_year_type %in% c("Wet", "Critical"), !is_outlier) %>% 
  ggplot(aes(end_year_type, difference, fill = end_year_type)) + 
  geom_boxplot() + 
  coord_flip() + 
  scale_fill_manual(values = c("#d7191c", "#2b83ba")) + 
  labs(fill="Year Type", x = "", y = "")

p2 <- one_year_differences %>%
  filter(end_year_type %in% c("Wet", "Critical"), !is_outlier) %>% 
  ggplot(aes(difference, fill = end_year_type)) + geom_density(alpha=0.6) + 
  scale_fill_manual(values = c("#d7191c", "#2b83ba")) + 
  labs(fill="Year Type")


grid.arrange(p1, p2, nrow = 2)
```

```{r}
crit_vals <- one_year_differences %>% filter(!is_outlier, end_year_type == "Critical") %>%
  pull(difference)

wet_vs_crit_t_test <- t.test(wet_vals, crit_vals)
```

*Wet or Above Normal vs Critical, Dry or Below Normal*

#### Question 2: Previous Year Type effect on Elevation Changes

```{r}
dry_types_to_wet <- one_year_differences %>% 
  filter(str_detect(year_type_change, "(Dry|Critical) to Wet")) %>% 
  mutate(is_outlier_for_dry_to_wet = ifelse(difference %in% boxplot(difference, plot=F)$out, T, F))

wet_types_to_wet <- one_year_differences %>% 
  filter(str_detect(year_type_change, "(Wet) to Wet")) %>% 
  mutate(is_outlier_for_dry_to_wet = ifelse(difference %in% boxplot(difference, plot=F)$out, T, F))

dry_types_to_wet %>%
  filter(!is_outlier_for_dry_to_wet) %>% 
  nrow() # 69

dry_types_to_wet %>% 
  filter(!is_outlier_for_dry_to_wet) %>% 
  ggplot(aes(end_year_type, difference)) + geom_boxplot() + 
  coord_flip()

shapiro.test(dry_types_to_wet[!dry_types_to_wet$is_outlier_for_dry_to_wet, ]$difference)
shapiro.test(wet_vals)

t.test(dry_types_to_wet[!dry_types_to_wet$is_outlier_for_dry_to_wet, ]$difference, alternative = "greater")
t.test(wet_vals, alternative = "greater")
t.test(wet_vals, dry_types_to_wet[!dry_types_to_wet$is_outlier_for_dry_to_wet, ]$difference)
```














