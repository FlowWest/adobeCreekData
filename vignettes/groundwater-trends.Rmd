---
title: "Groundwater Trends"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Groundwater Trends}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  # echo = FALSE, 
  warning = FALSE, 
  message = FALSE
)
```

```{r setup}
library(adobeCreekData)
library(tidyverse)
library(leaflet)
library(lubridate)
```


## Introduction 

In this article I explore groundwater elevation trends, we are interested in exploring 
elevation differences by water year. We will focus only on wells that have had recent
measurements. Ultimately we would like to develop confidence intervals for elevation change
based on the characteristics of a water year. 


## Groundwater Well Selection 

We will focus on wells where a groundwater elevation was reported for 2018. This
results in 23 candiate wells for analysis. This number will be smaller as we seek 
to make comparison across years.

```{r}
stations_with_recent_data <- groundwater_stations %>% 
  filter(year(end_date) >= 2018) 

elevation_data <- groundwater_levels %>% 
  filter(site_code %in% stations_with_recent_data$site_code) %>% 
  select(site_code, date = measurement_date, wse)


groundwater_stations %>% 
  filter(year(end_date) >= 2018) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers() 
```

## Elevation Change

Here I look at the change of elevation in one year. Here are the assumptions and requirements for
this analysis:

1. site code must have recent data to at least 2018
2. only subsequent years of data will be taken into account 
3. when attaching water year types to the fall difference we will always use the 
water year for September. For example even though the difference is from November 1980
to November 1981, the water year associated with this difference will be 1980.

**How the difference is calcualted**

The difference is calculated by subtracting the "start year" (smaller of the years) 
from the "end year". This means that a positive value indicates elevation increase
and a negative value indicates elevation decrease. When looking at the plot, a point
on 1980 shows the difference between 1979 and 1980. Lastly this subtraction is done 
on each well, so when looking the plot a single point shows the difference between 
two years at an individual site code. We can see the spread of the difference values
for a given year by focusing on one year on the x-axis and observing the range 
of values on the y-axis.

```{r}
wy_types <- 
  waterYearType::water_year_indices %>% 
  filter(location == "Sacramento Valley") %>% select(year = WY, type = Yr_type)

one_year_differences <- purrr::map_df(1948:2018, function(y) {
  # get the start and end years for the calcuation
  year1 <- y - 1
  year2 <- y
  
  # filter the data to just these two years
  d <- elevation_data %>% 
    filter(month(date) %in% 8:11, year(date) %in% c(year1, year2)) 
  
  # if there is no data for these two years do not do anything else
  if (nrow(d) == 0) return(NULL)
  d2 <- d %>% 
    mutate(year = ifelse(year(date) == year1, "start_year", "end_year")) %>% 
    select(-date) %>% 
    group_by_at(vars(-wse)) %>%  # group by everything other than the value column. 
    mutate(row_id=1:n()) %>% 
    ungroup() %>% 
    spread(year, wse) 
  
  if (!("end_year" %in% colnames(d2))) return(NULL)
  if (!("start_year" %in% colnames(d2))) return(NULL)
  
  d2 %>% 
    mutate(difference = end_year - start_year) %>% 
    filter(!is.na(difference)) %>% 
    mutate(end_year = year2, 
           start_year = year1)
}) %>% 
  left_join(wy_types, by = c("end_year" = "year")) %>% 
  rename(end_year_type = type) %>% 
  left_join(wy_types, by = c("start_year" = "year")) %>% 
  rename(start_year_type = type) %>% 
  mutate(year_type_change = paste0(start_year_type, " to ", end_year_type)) %>% 
  filter(!is.na(end_year_type))
```

**By Water Year Type (of End Year)**

Here I color the code the points by the water year type of the end year. That
is, when looking at the year 1980 the value indicates the difference between wells
from 1979 to 1980 but the color shows the water year type for 1980.

```{r}
one_year_differences %>% 
  ggplot(aes(end_year, difference, color=end_year_type)) + 
  geom_point(alpha=0.7) + 
  labs(title = "Water Year Type of End Year", color="", x = "", 
       y = "Elevation Change") + 
  scale_color_brewer(palette = "Spectral") + 
  theme(legend.position="bottom")
```

### Distribution of Elevation Changes

With the water years attached we can do some statistics using these as
categorical variables. We are mainly interested in significant differences in 
elevation change as a result of the water year types. Below is a boxplot that shows
the distribution of elevation change by water year type.

```{r}
one_year_differences %>% 
  ggplot(aes(end_year_type, difference, fill=end_year_type)) + 
  geom_boxplot() + 
  labs(x = "", y = "Elevation Change", 
       title = "Elevation Change Distribution by Water Year Types", 
       fill="") + 
  scale_fill_brewer(palette = "Spectral")  + 
  theme(legend.position="bottom")
```

Clearly there are differences between elevation changes when categorized by 
year types. In the next section I check whether these differences are statistically 
significant. 

#### Significant Differences between year types

In this section I analyze the distribution of elevation change between the water year
types. In particular we are interested in answering the following questions: 

1. Is there a significant difference between dry years (dry, critical) and wet years
(Abobe Normal, Wet).
2. Does the water year type of the previous affect the elevation change? If so how much?
3. Given a water year type is there a range of expected elevation change we can anticipate?
4. For all of the above, if we can't answer then question now, what additional data would 
we need to do so?

Several assumptions must be met before we develop statistical test

#### Question 1: Significant Differences between Year Types

The plan here is to use two sample test to check for significant differences in average elevation 
change between the water year types.

```{r}
one_year_differences %>% 
  filter(end_year_type == "Above Normal") %>% 
  ggplot(aes(sample = difference)) + 
  stat_qq() + stat_qq_line()

wet_year_vals <- one_year_differences %>% 
  filter(end_year_type == "Wet") 
an_year_vals <- one_year_differences %>% 
  filter(end_year_type == "Above Normal") %>% pull(difference) 
bn_year_vals <- one_year_differences %>% 
  filter(end_year_type == "Below Normal") %>% pull(difference) 
dry_year_vals <- one_year_differences %>% 
  filter(end_year_type == "Dry") %>% pull(difference)
crit_year_vals <- one_year_differences %>% 
  filter(end_year_type == "Critical") %>% pull(difference)

wet_year_outliers <- boxplot(wet_year_vals$difference, plot = FALSE)
wet_years_no_outliers <- 
  wet_year_vals[!(wet_year_vals$difference %in% wet_year_outliers$out), ]

shapiro.test(wet_years_no_outliers$difference)

wet_year_after_dry_vals <- one_year_differences %>% 
  filter(str_detect(year_type_change, "(Dry|Critical) to (Wet|Above Normal)")) %>% pull(difference)
```



### Distribution of Elevation Changes by Water Year Transitions

In this section I encode the *water year transition types*, that is I just keep 
track of the water year of the start year and the water year of the end year and
add this as a column to the dataframe.

**Dry to Wet and Wet to Dry Transitions**

Here I focus on the Wet to Dry and Dry to Wet transitions. 

```{r}
one_year_differences %>% 
  ggplot(aes(difference, fill=year_type_change, color=year_type_change)) + geom_density(alpha=0.5)
```

**Critical to Wet and Wet to Critical Transitions**















